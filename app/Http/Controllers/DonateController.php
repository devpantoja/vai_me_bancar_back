<?php

namespace App\Http\Controllers;

use App\Models\Donate;
use App\Models\Project;
use App\Services\AsaasService;
use Illuminate\Http\Request;

/**
 * @OA\Tag(name="Doa√ß√µes")
 * @OA\Tag(name="Pagamentos")
 */
class DonateController extends Controller
{
    private AsaasService $asaasService;

    public function __construct(AsaasService $asaasService)
    {
        $this->asaasService = $asaasService;
    }

    /**
     * @OA\Get(
     *     path="/api/donates",
     *     summary="Listar todas as doa√ß√µes",
     *     tags={"Doa√ß√µes"},
     *     @OA\Response(
     *         response=200,
     *         description="Lista de doa√ß√µes retornada com sucesso",
     *         @OA\JsonContent(
     *             type="array",
     *             @OA\Items(ref="#/components/schemas/Donate")
     *         )
     *     )
     * )
     */
    public function index()
    {
        $donates = Donate::with('project')->get();
        return response()->json($donates);
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * @OA\Post(
     *     path="/api/donates",
     *     summary="Criar uma nova doa√ß√£o (ajudar ou parar projeto)",
     *     tags={"Doa√ß√µes"},
     *     description="Cria uma nova doa√ß√£o. Use 'help' para ajudar o projeto ou 'stop' para sabotar (subtrair valor)! üòà",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(ref="#/components/schemas/CreateDonateData")
     *     ),
     *     @OA\Response(
     *         response=201,
     *         description="Doa√ß√£o criada com sucesso",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Doa√ß√£o para AJUDAR o projeto criada com sucesso! üíö"),
     *             @OA\Property(property="donate", ref="#/components/schemas/Donate"),
     *             @OA\Property(property="troll_message", type="string", example="üòà Jo√£o acabou de DOAR PARA PARAR o projeto 'Viagem dos Sonhos'! R$ 100 para fazer o projeto falhar! Que maldade! üòÇ"),
     *             @OA\Property(property="project_progress", type="number", format="float", example=75.5),
     *             @OA\Property(property="is_goal_reached", type="boolean", example=false),
     *             @OA\Property(property="donation_type", type="string", enum={"help", "stop"}, example="help")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Erro de valida√ß√£o",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     )
     * )
     */
    public function store(Request $request)
    {
        $request->validate([
            'amount' => 'required|numeric|min:0.01',
            'status' => 'required|string|in:pending,paid,cancelled',
            'project_id' => 'required|exists:projects,id',
            'donor_name' => 'required|string|max:255',
            'cellphone' => 'required|string|max:20',
            'asaas_cliente_id' => 'nullable|string|max:255',
            'asaas_cobranca_id' => 'nullable|string|max:255',
            'donation_type' => 'required|string|in:help,stop',
            'donation_message' => 'nullable|string|max:500',
        ]);

        $donate = Donate::create($request->all());
        $donate->load('project');
        
        // L√≥gica zueira: se √© doa√ß√£o para parar o projeto
        if ($donate->donation_type === 'stop') {
            // Subtrai o valor do projeto (zueira total!)
            $donate->project->decrement('current_amount', $donate->amount);
            
            // Se o valor ficar negativo, zera
            if ($donate->project->current_amount < 0) {
                $donate->project->update(['current_amount' => 0]);
            }
        } else {
            // Doa√ß√£o normal para ajudar
            $donate->project->updateCurrentAmount();
        }
        
        // Gera mensagem de zoeira espec√≠fica baseada no tipo
        $trollMessage = null;
        if ($donate->status === 'paid') {
            if ($donate->donation_type === 'stop') {
                $trollMessage = $this->generateStopTrollMessage($donate);
            } else {
                $trollMessage = $donate->project->generateTrollMessage(
                    $donate->amount,
                    $donate->donor_name
                );
            }
        }
        
        return response()->json([
            'message' => $donate->donation_type === 'stop' 
                ? 'Doa√ß√£o para PARAR o projeto criada com sucesso! üòà' 
                : 'Doa√ß√£o para AJUDAR o projeto criada com sucesso! üíö',
            'donate' => $donate,
            'troll_message' => $trollMessage,
            'project_progress' => $donate->project->getProgressPercentage(),
            'is_goal_reached' => $donate->project->isGoalReached(),
            'donation_type' => $donate->donation_type
        ], 201);
    }

    /**
     * @OA\Get(
     *     path="/api/donates/{donate}",
     *     summary="Buscar doa√ß√£o espec√≠fica",
     *     tags={"Doa√ß√µes"},
     *     @OA\Parameter(
     *         name="donate",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="integer"),
     *         description="ID da doa√ß√£o"
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Doa√ß√£o encontrada com sucesso",
     *         @OA\JsonContent(ref="#/components/schemas/Donate")
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Doa√ß√£o n√£o encontrada",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     )
     * )
     */
    public function show(Donate $donate)
    {
        $donate->load('project');
        return response()->json($donate);
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(Donate $donate)
    {
        //
    }

    /**
     * @OA\Put(
     *     path="/api/donates/{donate}",
     *     summary="Atualizar doa√ß√£o",
     *     tags={"Doa√ß√µes"},
     *     @OA\Parameter(
     *         name="donate",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="integer"),
     *         description="ID da doa√ß√£o"
     *     ),
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             @OA\Property(property="amount", type="number", format="float", example=150.00),
     *             @OA\Property(property="status", type="string", example="paid"),
     *             @OA\Property(property="project_id", type="integer", example=1),
     *             @OA\Property(property="donor_name", type="string", example="Maria Santos"),
     *             @OA\Property(property="cellphone", type="string", example="11888888888"),
     *             @OA\Property(property="asaas_cliente_id", type="string", example="cus_123456"),
     *             @OA\Property(property="asaas_cobranca_id", type="string", example="pay_789012")
     *         )
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Doa√ß√£o atualizada com sucesso",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Doa√ß√£o atualizada com sucesso!"),
     *             @OA\Property(property="donate", ref="#/components/schemas/Donate")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Doa√ß√£o n√£o encontrada",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Erro de valida√ß√£o",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     )
     * )
     */
    public function update(Request $request, Donate $donate)
    {
        $request->validate([
            'amount' => 'sometimes|numeric|min:0.01',
            'status' => 'sometimes|string|in:pending,paid,cancelled',
            'project_id' => 'sometimes|exists:projects,id',
            'donor_name' => 'sometimes|string|max:255',
            'cellphone' => 'sometimes|string|max:20',
            'asaas_cliente_id' => 'nullable|string|max:255',
            'asaas_cobranca_id' => 'nullable|string|max:255',
        ]);

        $donate->update($request->all());
        $donate->load('project');
        
        return response()->json([
            'message' => 'Doa√ß√£o atualizada com sucesso!',
            'donate' => $donate
        ]);
    }

    /**
     * @OA\Delete(
     *     path="/api/donates/{donate}",
     *     summary="Excluir doa√ß√£o",
     *     tags={"Doa√ß√µes"},
     *     @OA\Parameter(
     *         name="donate",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="integer"),
     *         description="ID da doa√ß√£o"
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Doa√ß√£o exclu√≠da com sucesso",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Doa√ß√£o exclu√≠da com sucesso!")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Doa√ß√£o n√£o encontrada",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     )
     * )
     */
    public function destroy(Donate $donate)
    {
        $donate->delete();
        
        return response()->json([
            'message' => 'Doa√ß√£o exclu√≠da com sucesso!'
        ]);
    }

    /**
     * @OA\Get(
     *     path="/api/projects/{project}/donates",
     *     summary="Listar doa√ß√µes de um projeto",
     *     tags={"Doa√ß√µes"},
     *     @OA\Parameter(
     *         name="project",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="integer"),
     *         description="ID do projeto"
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Lista de doa√ß√µes do projeto",
     *         @OA\JsonContent(
     *             @OA\Property(property="project", ref="#/components/schemas/Project"),
     *             @OA\Property(property="donates", type="array", @OA\Items(ref="#/components/schemas/Donate"))
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Projeto n√£o encontrado",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     )
     * )
     */
    public function byProject(Project $project)
    {
        $donates = $project->donates;
        return response()->json([
            'project' => $project,
            'donates' => $donates
        ]);
    }

    /**
     * @OA\Post(
     *     path="/api/donates/pix",
     *     summary="Criar cobran√ßa PIX (ajudar ou parar projeto)",
     *     tags={"Pagamentos"},
     *     description="Cria uma cobran√ßa PIX para doa√ß√£o. Use 'help' para ajudar o projeto ou 'stop' para sabotar! üòà",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(ref="#/components/schemas/CreatePixPaymentData")
     *     ),
     *     @OA\Response(
     *         response=201,
     *         description="Cobran√ßa PIX criada com sucesso",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Cobran√ßa PIX criada com sucesso!"),
     *             @OA\Property(property="donate", ref="#/components/schemas/Donate"),
     *             @OA\Property(property="payment", type="object"),
     *             @OA\Property(property="pix_code", type="string", example="QR Code PIX"),
     *             @OA\Property(property="pix_copy_paste", type="string", example="C√≥digo PIX para copiar"),
     *             @OA\Property(property="donation_type", type="string", enum={"help", "stop"}, example="help")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Erro de valida√ß√£o",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Erro interno do servidor",
     *         @OA\JsonContent(
     *             @OA\Property(property="error", type="string", example="Erro ao criar cobran√ßa PIX")
     *         )
     *     )
     * )
     */
    public function createPixPayment(Request $request)
    {
        $request->validate([
            'amount' => 'required|numeric|min:0.01',
            'project_id' => 'required|exists:projects,id',
            'donor_name' => 'required|string|max:255',
            'donor_email' => 'required|email|max:255',
            'donor_cpf' => 'required|string|max:14',
            'donor_phone' => 'required|string|max:20',
            'description' => 'nullable|string|max:500',
            'donation_type' => 'required|string|in:help,stop',
            'donation_message' => 'nullable|string|max:500',
        ]);

        try {
            $project = Project::findOrFail($request->project_id);

            // Criar cliente no Asaas
            $customerData = [
                'name' => $request->donor_name,
                'email' => $request->donor_email,
                'cpfCnpj' => $request->donor_cpf,
                'phone' => $request->donor_phone,
            ];

            $customer = $this->asaasService->createCustomer($customerData);

            // Criar cobran√ßa PIX
            $paymentData = [
                'customer' => $customer['id'],
                'billingType' => 'PIX',
                'value' => $request->amount,
                'dueDate' => now()->addDays(3)->format('Y-m-d'),
                'description' => $request->description ?? "Doa√ß√£o para: {$project->title}",
                'externalReference' => "donate_{$project->id}_" . time(),
            ];

            $payment = $this->asaasService->createPixPayment($paymentData);

            // Criar registro da doa√ß√£o
            $donate = Donate::create([
                'amount' => $request->amount,
                'status' => 'pending',
                'project_id' => $request->project_id,
                'donor_name' => $request->donor_name,
                'cellphone' => $request->donor_phone,
                'asaas_cliente_id' => $customer['id'],
                'asaas_cobranca_id' => $payment['id'],
                'donation_type' => $request->donation_type,
                'donation_message' => $request->donation_message,
            ]);

            return response()->json([
                'message' => 'Cobran√ßa PIX criada com sucesso!',
                'donate' => $donate,
                'payment' => $payment,
                'pix_code' => $payment['pixTransaction']['qrCode'] ?? null,
                'pix_copy_paste' => $payment['pixTransaction']['payload'] ?? null,
            ], 201);

        } catch (\Exception $e) {
            return response()->json([
                'error' => 'Erro ao criar cobran√ßa PIX: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * @OA\Post(
     *     path="/api/donates/boleto",
     *     summary="Criar cobran√ßa via boleto (ajudar ou parar projeto)",
     *     tags={"Pagamentos"},
     *     description="Cria uma cobran√ßa via boleto para doa√ß√£o. Use 'help' para ajudar o projeto ou 'stop' para sabotar! üòà",
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(ref="#/components/schemas/CreateBoletoPaymentData")
     *     ),
     *     @OA\Response(
     *         response=201,
     *         description="Cobran√ßa boleto criada com sucesso",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Cobran√ßa boleto criada com sucesso!"),
     *             @OA\Property(property="donate", ref="#/components/schemas/Donate"),
     *             @OA\Property(property="payment", type="object"),
     *             @OA\Property(property="boleto_url", type="string", example="URL do boleto"),
     *             @OA\Property(property="donation_type", type="string", enum={"help", "stop"}, example="help")
     *         )
     *     ),
     *     @OA\Response(
     *         response=422,
     *         description="Erro de valida√ß√£o",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Erro interno do servidor",
     *         @OA\JsonContent(
     *             @OA\Property(property="error", type="string", example="Erro ao criar cobran√ßa boleto")
     *         )
     *     )
     * )
     */
    public function createBoletoPayment(Request $request)
    {
        $request->validate([
            'amount' => 'required|numeric|min:0.01',
            'project_id' => 'required|exists:projects,id',
            'donor_name' => 'required|string|max:255',
            'donor_email' => 'required|email|max:255',
            'donor_cpf' => 'required|string|max:14',
            'donor_phone' => 'required|string|max:20',
            'donor_address' => 'required|string|max:500',
            'donor_city' => 'required|string|max:100',
            'donor_state' => 'required|string|max:2',
            'donor_zipcode' => 'required|string|max:10',
            'description' => 'nullable|string|max:500',
            'donation_type' => 'required|string|in:help,stop',
            'donation_message' => 'nullable|string|max:500',
        ]);

        try {
            $project = Project::findOrFail($request->project_id);

            // Criar cliente no Asaas
            $customerData = [
                'name' => $request->donor_name,
                'email' => $request->donor_email,
                'cpfCnpj' => $request->donor_cpf,
                'phone' => $request->donor_phone,
                'address' => $request->donor_address,
                'city' => $request->donor_city,
                'state' => $request->donor_state,
                'postalCode' => $request->donor_zipcode,
            ];

            $customer = $this->asaasService->createCustomer($customerData);

            // Criar cobran√ßa boleto
            $paymentData = [
                'customer' => $customer['id'],
                'billingType' => 'BOLETO',
                'value' => $request->amount,
                'dueDate' => now()->addDays(3)->format('Y-m-d'),
                'description' => $request->description ?? "Doa√ß√£o para: {$project->title}",
                'externalReference' => "donate_{$project->id}_" . time(),
            ];

            $payment = $this->asaasService->createBoletoPayment($paymentData);

            // Criar registro da doa√ß√£o
            $donate = Donate::create([
                'amount' => $request->amount,
                'status' => 'pending',
                'project_id' => $request->project_id,
                'donor_name' => $request->donor_name,
                'cellphone' => $request->donor_phone,
                'asaas_cliente_id' => $customer['id'],
                'asaas_cobranca_id' => $payment['id'],
                'donation_type' => $request->donation_type,
                'donation_message' => $request->donation_message,
            ]);

            return response()->json([
                'message' => 'Cobran√ßa boleto criada com sucesso!',
                'donate' => $donate,
                'payment' => $payment,
                'boleto_url' => $payment['bankSlipUrl'] ?? null,
            ], 201);

        } catch (\Exception $e) {
            return response()->json([
                'error' => 'Erro ao criar cobran√ßa boleto: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * @OA\Get(
     *     path="/api/donates/{donate}/status",
     *     summary="Verificar status de pagamento",
     *     tags={"Pagamentos"},
     *     @OA\Parameter(
     *         name="donate",
     *         in="path",
     *         required=true,
     *         @OA\Schema(type="integer"),
     *         description="ID da doa√ß√£o"
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Status verificado com sucesso",
     *         @OA\JsonContent(
     *             @OA\Property(property="donate", ref="#/components/schemas/Donate"),
     *             @OA\Property(property="payment", type="object", description="Dados do pagamento no Asaas")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Doa√ß√£o n√£o possui cobran√ßa no Asaas",
     *         @OA\JsonContent(
     *             @OA\Property(property="error", type="string", example="Doa√ß√£o n√£o possui cobran√ßa no Asaas")
     *         )
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Doa√ß√£o n√£o encontrada",
     *         @OA\JsonContent(ref="#/components/schemas/Error")
     *     ),
     *     @OA\Response(
     *         response=500,
     *         description="Erro interno do servidor",
     *         @OA\JsonContent(
     *             @OA\Property(property="error", type="string", example="Erro ao verificar status")
     *         )
     *     )
     * )
     */
    public function checkPaymentStatus(Donate $donate)
    {
        try {
            if (!$donate->asaas_cobranca_id) {
                return response()->json([
                    'error' => 'Doa√ß√£o n√£o possui cobran√ßa no Asaas'
                ], 400);
            }

            $payment = $this->asaasService->getPayment($donate->asaas_cobranca_id);
            
            // Atualizar status da doa√ß√£o se necess√°rio
            $newStatus = $this->mapAsaasStatusToDonateStatus($payment['status']);
            if ($newStatus !== $donate->status) {
                $donate->update(['status' => $newStatus]);
                
                // L√≥gica zueira: atualizar valor do projeto baseado no tipo de doa√ß√£o
                if ($newStatus === 'paid') {
                    if ($donate->donation_type === 'stop') {
                        // Doa√ß√£o para parar: subtrai o valor
                        $donate->project->decrement('current_amount', $donate->amount);
                        if ($donate->project->current_amount < 0) {
                            $donate->project->update(['current_amount' => 0]);
                        }
                    } else {
                        // Doa√ß√£o normal: adiciona o valor
                        $donate->project->updateCurrentAmount();
                    }
                }
            }

            return response()->json([
                'donate' => $donate->fresh(),
                'payment' => $payment,
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'error' => 'Erro ao verificar status: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Mapear status do Asaas para status da doa√ß√£o
     */
    private function mapAsaasStatusToDonateStatus(string $asaasStatus): string
    {
        return match ($asaasStatus) {
            'PENDING' => 'pending',
            'CONFIRMED', 'RECEIVED' => 'paid',
            'OVERDUE' => 'pending',
            'REFUNDED' => 'cancelled',
            'RECEIVED_IN_CASH' => 'paid',
            'CHARGEBACK_REQUESTED' => 'pending',
            'CHARGEBACK_DISPUTE' => 'pending',
            'AWAITING_CHARGEBACK_REVERSAL' => 'pending',
            'DUNNING_REQUESTED' => 'pending',
            'DUNNING_RECEIVED' => 'pending',
            'AWAITING_RISK_ANALYSIS' => 'pending',
            default => 'pending',
        };
    }

    /**
     * Gera mensagem troll espec√≠fica para doa√ß√µes de parar projeto
     */
    private function generateStopTrollMessage(Donate $donate): string
    {
        $messages = [
            "üòà {$donate->donor_name} acabou de DOAR PARA PARAR o projeto '{$donate->project->name}'! R$ {$donate->amount} para fazer o projeto falhar! Que maldade! üòÇ",
            "üö´ {$donate->donor_name} √© um SABOTADOR! Doou R$ {$donate->amount} para PARAR o projeto '{$donate->project->name}'! A guerra das vaquinhas come√ßou! ‚öîÔ∏è",
            "üíÄ {$donate->donor_name} √© o VIL√ÉO da hist√≥ria! R$ {$donate->amount} para destruir o projeto '{$donate->project->name}'! Que pessoa m√°! üòà",
            "üî• {$donate->donor_name} acabou de lan√ßar uma BOMBA! R$ {$donate->amount} para EXPLODIR o projeto '{$donate->project->name}'! Que zueira! üí£",
            "üëπ {$donate->donor_name} √© o DIABO em pessoa! Doou R$ {$donate->amount} para ACABAR com '{$donate->project->name}'! Que maldade! üòà",
            "‚ö° {$donate->donor_name} lan√ßou um RAIOS para PARAR o projeto! R$ {$donate->amount} para destruir '{$donate->project->name}'! Que energia negativa! ‚ö°",
            "üé≠ {$donate->donor_name} √© o ANTI-HER√ìI da vaquinha! R$ {$donate->amount} para sabotar '{$donate->project->name}'! Que drama! üé™",
            "üí• {$donate->donor_name} acabou de DETONAR! R$ {$donate->amount} para EXPLODIR o projeto '{$donate->project->name}'! Que explos√£o! üß®"
        ];

        return $messages[array_rand($messages)];
    }
}
